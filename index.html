<!DOCTYPE html>
<html ng-app="salesApp">
<head>
    <meta charset="UTF-8">
    <title>Store Sales/Product/Customer Management</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.3/angular.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body ng-controller="SalesController">
    <div class="container">
        <h1>Store Sales & Product Management</h1>
        <div class="tabs">
            <button ng-click="setTab('admin')" ng-class="{'active':activeTab==='admin'}">Admin Login</button>
            <button ng-click="setTab('sales')" ng-class="{'active':activeTab==='sales'}" ng-if="isAdmin">Sales</button>
            <button ng-click="setTab('customers')" ng-class="{'active':activeTab==='customers'}" ng-if="isAdmin">Customers</button>
            <button ng-click="setTab('products')" ng-class="{'active':activeTab==='products'}" ng-if="isAdmin">Products</button>
        </div>
        <div style="margin:10px 0; font-size:14px; color:#555;">
            Current tab: <strong>{{activeTab}}</strong> | Admin: <strong>{{isAdmin}}</strong>
        </div>
        <!-- Admin Login Tab -->
        <div ng-show="activeTab==='admin'">
            <div class="card login-form" ng-if="!isAdmin">
                <h2>Admin Login</h2>
                <form ng-submit="loginAdmin()">
                    <input type="text" ng-model="adminLogin.username" placeholder="Username" required>
                    <input type="password" ng-model="adminLogin.password" placeholder="Password" required>
                    <button type="submit">Login</button>
                </form>
                <div class="error" ng-if="adminLoginError">{{adminLoginError}}</div>
            </div>
            <div class="card" ng-if="isAdmin">
                <h2>Welcome, Admin!</h2>
                <button ng-click="logoutAdmin()">Logout</button>
                <p>You now have access to the full dashboard.</p>
            </div>
        </div>
        <!-- Sales Tab -->
        <div ng-show="activeTab==='sales' && isAdmin">
            <form ng-submit="saveSale()" class="card colorful-form">
                <h2>{{ sale.id ? 'Edit Sale' : 'Add Sale' }}</h2>
                <select ng-model="sale.product_id" required>
                    <option value="">Select Product</option>
                    <option ng-repeat="p in products" value="{{p.id}}">{{p.name}} (₹{{p.price}})</option>
                </select>
                <input type="number" ng-model="sale.quantity" placeholder="Quantity" required>
                <input type="date" ng-model="sale.sale_date" placeholder="Date" required>
                <select ng-model="sale.customer_id" required>
                    <option value="">Select Customer</option>
                    <option ng-repeat="c in customers" value="{{c.id}}">{{c.name}}</option>
                </select>
                <div class="form-actions">
                    <button type="submit">{{ sale.id ? 'Update' : 'Add' }} Sale</button>
                    <button type="button" ng-click="resetSaleForm()">Clear</button>
                </div>
            </form>
            <div class="card">
                <h2>Sales List</h2>
                <table class="colorful-table">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Quantity</th>
                            <th>Date</th>
                            <th>Customer</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr ng-repeat="s in sales">
                            <td>{{s.product_name}} (₹{{s.product_price}})</td>
                            <td>{{s.quantity}}</td>
                            <td>{{s.sale_date | date:'yyyy-MM-dd'}}</td>
                            <td>{{s.customer_name}}</td>
                            <td>
                                <button class="edit-btn" ng-click="editSale(s)">Edit</button>
                                <button class="del-btn" ng-click="deleteSale(s.id)">Delete</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="card">
                <h2>Sales Report (Total Sales by Product)</h2>
                <canvas id="salesChart" height="120"></canvas>
            </div>
        </div>
        <!-- Customers Tab -->
        <div ng-show="activeTab==='customers' && isAdmin">
            <form ng-submit="saveCustomer()" class="card colorful-form">
                <h2>{{ customer.id ? 'Edit Customer' : 'Add Customer' }}</h2>
                <input type="text" ng-model="customer.name" placeholder="Customer Name" required>
                <input type="email" ng-model="customer.email" placeholder="Email" required>
                <input type="text" ng-model="customer.phone" placeholder="Phone">
                <div class="form-actions">
                    <button type="submit">{{ customer.id ? 'Update' : 'Add' }} Customer</button>
                    <button type="button" ng-click="resetCustomerForm()">Clear</button>
                </div>
            </form>
            <div class="card">
                <h2>Customer List</h2>
                <table class="colorful-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Phone</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr ng-repeat="c in customers">
                            <td>{{c.name}}</td>
                            <td>{{c.email}}</td>
                            <td>{{c.phone}}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <!-- Products Tab -->
        <div ng-show="activeTab==='products' && isAdmin">
            <form ng-submit="saveProduct()" class="card colorful-form">
                <h2>{{ product.id ? 'Edit Product' : 'Add Product' }}</h2>
                <input type="text" ng-model="product.name" placeholder="Product Name" required>
                <input type="text" ng-model="product.description" placeholder="Description">
                <input type="number" ng-model="product.price" placeholder="Price" required>
                <div class="form-actions">
                    <button type="submit">{{ product.id ? 'Update' : 'Add' }} Product</button>
                    <button type="button" ng-click="resetProductForm()">Clear</button>
                </div>
            </form>
            <div class="card">
                <h2>Product List</h2>
                <table class="colorful-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Description</th>
                            <th>Price</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr ng-repeat="p in products">
                            <td>{{p.name}}</td>
                            <td>{{p.description}}</td>
                            <td>{{p.price}}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <script>
    angular.module('salesApp', [])
    .controller('SalesController', function($scope, $http) {
        $scope.activeTab = 'admin';
        $scope.sales = [];
        $scope.customers = [];
        $scope.products = [];
        $scope.sale = {};
        $scope.customer = {};
        $scope.product = {};
        $scope.salesChart = null;

        $scope.adminLogin = {};
        $scope.adminLoginError = '';
        $scope.isAdmin = false;

        $scope.setTab = function(tab) {
            $scope.activeTab = tab;
        };

        // Check admin session on load
        $http.get('http://localhost:3000/api/admin/check', { withCredentials: true })
            .then(function(res) {
                $scope.isAdmin = res.data.loggedIn;
                if ($scope.isAdmin) {
                    loadSales();
                    loadCustomers();
                    loadProducts();
                    $scope.activeTab = 'sales';
                }
            });

        $scope.loginAdmin = function() {
            $http.post('http://localhost:3000/api/admin/login', $scope.adminLogin, { withCredentials: true })
                .then(function(res) {
                    $scope.isAdmin = true;
                    $scope.adminLoginError = '';
                    loadSales();
                    loadCustomers();
                    loadProducts();
                    $scope.activeTab = 'sales';
                }, function(res) {
                    $scope.adminLoginError = res.data.error || 'Login failed';
                });
        };
        $scope.logoutAdmin = function() {
            $http.post('http://localhost:3000/api/admin/logout', {}, { withCredentials: true })
                .then(function() {
                    $scope.isAdmin = false;
                    $scope.activeTab = 'admin';
                });
        };

        function loadSales() {
            $http.get('http://localhost:3000/api/sales')
                .then(function(res) {
                    $scope.sales = res.data;
                    renderChart();
                });
        }
        function loadCustomers() {
            $http.get('http://localhost:3000/api/customers')
                .then(function(res) {
                    // Remove duplicate emails
                    const unique = {};
                    res.data.forEach(c => { unique[c.email] = c; });
                    $scope.customers = Object.values(unique);
                });
        }
        function loadProducts() {
            $http.get('http://localhost:3000/api/products')
                .then(function(res) {
                    $scope.products = res.data;
                });
        }

        $scope.saveSale = function() {
            if ($scope.sale.id) {
                $http.put('http://localhost:3000/api/sales/' + $scope.sale.id, $scope.sale)
                    .then(function() {
                        loadSales();
                        $scope.resetSaleForm();
                    });
            } else {
                $http.post('http://localhost:3000/api/sales', $scope.sale)
                    .then(function() {
                        loadSales();
                        $scope.resetSaleForm();
                    });
            }
        };
        $scope.editSale = function(sale) {
            sale.sale_date = sale.sale_date ? sale.sale_date.slice(0,10) : '';
            $scope.sale = angular.copy(sale);
        };
        $scope.deleteSale = function(id) {
            if (confirm('Are you sure you want to delete this sale?')) {
                $http.delete('http://localhost:3000/api/sales/' + id)
                    .then(function() {
                        loadSales();
                    });
            }
        };
        $scope.resetSaleForm = function() {
            $scope.sale = {};
        };

        $scope.saveCustomer = function() {
            if ($scope.customer.id) {
                // Could add edit endpoint
            } else {
                $http.post('http://localhost:3000/api/customers', $scope.customer)
                    .then(function() {
                        loadCustomers();
                        $scope.resetCustomerForm();
                    }, function(res) {
                        alert(res.data.error || 'Could not add customer.');
                    });
            }
        };
        $scope.resetCustomerForm = function() {
            $scope.customer = {};
        };

        $scope.saveProduct = function() {
            if ($scope.product.id) {
                // Could add edit endpoint
            } else {
                $http.post('http://localhost:3000/api/products', $scope.product)
                    .then(function() {
                        loadProducts();
                        $scope.resetProductForm();
                    });
            }
        };
        $scope.resetProductForm = function() {
            $scope.product = {};
        };

        // Chart: Sales by Product
        function renderChart() {
            const salesByProduct = {};
            $scope.products.forEach(p => salesByProduct[p.name] = 0);
            $scope.sales.forEach(sale => {
                const pname = sale.product_name || 'Unknown';
                const total = (sale.product_price || 0) * sale.quantity;
                salesByProduct[pname] = (salesByProduct[pname] || 0) + total;
            });
            const labels = Object.keys(salesByProduct);
            const data = Object.values(salesByProduct);

            const ctx = document.getElementById('salesChart').getContext('2d');
            if ($scope.salesChart) $scope.salesChart.destroy();
            $scope.salesChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total Sales ₹',
                        data: data,
                        backgroundColor: ['#4a7cfa', '#31c6ff', '#ff4e78', '#8a98b3', '#28a745', '#dc3545']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }
    });
    </script>
</body>
</html>
